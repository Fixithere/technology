
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>LMC Technology blog</title>
  <meta name="author" content="LMC s.r.o.">

  
  <meta name="description" content="I&#8217;ve prepared this presentation for purposes of our company and it describes benefits of utilizing Swiffy conversion tool for our/client banner &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lmc-eu.github.com/technology//">
  <link href="/technology/favicon.png" rel="icon">
  <link href="/technology/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/technology/javascripts/modernizr-2.0.js"></script>
  <script src="/technology/javascripts/ender.js"></script>
  <script src="/technology/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="LMC Technology blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36380287-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/technology/">LMC Technology blog</a></h1>
  
    <h2>Assorted thoughts of LMC engineers</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:lmc-eu.github.com/technology/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/technology/">Blog</a></li>
  <li><a href="/technology/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/technology/blog/2013/02/19/swiffy-for-swf-banners-help/">Swiffy for SWF Banners Help</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-19T10:00:00+01:00" pubdate data-updated="true">Feb 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve prepared this presentation for purposes of our company and it describes benefits of utilizing <a href="https://www.google.com/doubleclick/studio/swiffy/">Swiffy</a> conversion tool for our/client banner ads business.
Our creative guys are great when using <em>Adobe Flash Professional</em> authoring tool and our customers love it, but <strong>growing iOS devices market share</strong> is already forcing us to change our current technology approach. This presentation should help us with the transformation process.</p>

<p>New <a href="https://github.com/paulrouget/dzslides">DZSlides</a> version, which I&#8217;ve used as the presentation engine, is a little bit less MSIE 9 friendly then its previous releases and I had to hack it a bit. So now the presentation works well in MSIE 10, Firefox, Chrome, Safari, Opera and acceptably also on MSIE 9 as well, but sorry, MSIE 8- &#8230;
In the presentation slides is purposefully <strong>embedded SWF file</strong> and to have it <em>visible in Gecko browsers</em>, there is a trick, which must be used - add <strong>wmode=&#8221;opaque&#8221;</strong> to the Flash object tag declaration; maybe will this hint save you some time, well, it cost me a lot to discover this, to be honest&#8230;</p>

<ul>
<li><a href="../assets/swiffy.html">Presentation Itself</a> which contains a lot of information for you to know how <em>(and if)</em> start to think differently, about how to serve/use your <em>Adobe-Fixed-Creatives</em> banner content</li>
<li><a href="../assets/banner.htm">Simple Banner Fallback Example</a> shows easiest possible markup for you to test proposed fallback scenario <em>(yes. MSIE 8 users, this is the only sensible link for you there&#8230;)</em></li>
<li><a href="http://svg.kvalitne.cz/swiffy/gallery.html">Sample Conversion Gallery</a> is collection of <em>(mostly)</em> LMC banners with positive results of Swiffy conversion process, with some comments, file size comparisons etc. <em>(those demos do not have proposed fallback applied to them so SVG aware browser is a must!)</em> Gallery is temporarily hosted on different server, because of some special mime type handling.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/technology/blog/2013/01/21/groovy-testng-tests/">Groovy Testng Tests</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-21T13:52:00+01:00" pubdate data-updated="true">Jan 21<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post is not about using groovy to write unit tests (just warning for those who haven&#8217;t tried it yet and still use java: it&#8217;s addictive), but rather about one particular problem:
how to run them? Maven surefire plugin should, in theory, run them - there is even explicit support. Unfortunately, this plugin is (like many maven plugins) riddled with bugs and I haven&#8217;t seen
single version without at least one bug in testng support. Usually, it fails to find groovy tests.</p>

<p>One obvious workaround is to compile groovy to <code>.class</code> files. When compiled, groovy classes are found by surefire just like java ones. This solution, however, is quite complicated and just feels wrong.</p>

<p>Another solution is quite obscure, but perfect: testng <code>@Factory</code> annotation.
This method is called on any testng instance that had been already found and the result (array) is then added to list of testng instances to execute. In short, this allows us to &#8220;spawn&#8221; other tests.</p>

<p>Less talking, more code:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">groovy.lang.GroovyClassLoader</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">groovy.lang.Script</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.codehaus.groovy.control.CompilationFailedException</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.codehaus.groovy.runtime.DefaultGroovyMethods</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.core.io.Resource</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.core.io.support.PathMatchingResourcePatternResolver</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.testng.annotations.Factory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * This is not really test, this is just runner fro groovy tests.</span>
</span><span class='line'><span class="cm"> * Maven Surefire plugin can, in theory, run these tests by itself; unfortunately it fails on classes</span>
</span><span class='line'><span class="cm"> * without default constructor and on scripts.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroovyRunnerTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">GroovyClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroovyClassLoader</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Factory</span><span class="o">()</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">createTests</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;createTests: &quot;</span> <span class="o">+</span> <span class="n">loader</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">PathMatchingResourcePatternResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PathMatchingResourcePatternResolver</span><span class="o">(</span><span class="n">loader</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">Resource</span><span class="o">[]</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="s">&quot;classpath:**/*Test.groovy&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">tests</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;(</span><span class="n">resources</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span> <span class="o">:</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">final</span> <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">DefaultGroovyMethods</span><span class="o">.</span><span class="na">getText</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="s">&quot;UTF-8&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">parseClass</span><span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="n">resource</span><span class="o">.</span><span class="na">getFilename</span><span class="o">());</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;groovy class: &quot;</span> <span class="o">+</span> <span class="n">clazz</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">Script</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;skipping groovy script: &quot;</span> <span class="o">+</span> <span class="n">resource</span><span class="o">);</span>
</span><span class='line'>                    <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="kd">final</span> <span class="n">Object</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
</span><span class='line'>                <span class="n">tests</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CompilationFailedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;failed to load class: &quot;</span> <span class="o">+</span> <span class="n">resource</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;failed to instantiate class: &quot;</span> <span class="o">+</span> <span class="n">resource</span><span class="o">);</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;failed to instantiate class: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>                <span class="c1">//ignore</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">tests</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">tests</span><span class="o">.</span><span class="na">size</span><span class="o">()]);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/technology/blog/2013/01/20/jaxb-bug-in-java-6/">JAXB Bug in Java 6</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-20T11:41:00+01:00" pubdate data-updated="true">Jan 20<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Short version</h1>

<p><strong>JAXB implementation embedded in Java 6 is broken, don&#8217;t use it.</strong>
Java 7 is ok, if you&#8217;re lucky enough to use latest java version.</p>

<p>To check if your implementation is correct, you can use tool at <a href="https://github.com/podlesh/jaxb-bug">github</a></p>

<h1>Long story version</h1>

<p>I discovered this bug when I wrote some utility classes for marshalling and unmarshalling JAXB objects (lots of boilerplate code, but that&#8217;s different story).
As a conscientious and responsible developer, I wrote unit test. This unit test contains also test case that repeatedly deserializes and serializes xml field, checking
that the result is the same. Unit tests were green, so commit and push followed. And in a few minutes, Jenkins reported broken test.</p>

<p>WTF? There must be some difference in environment&#8230; and it certainly is: Jenkins job uses jdk 1.6 while I use jdk 1.7 by default (on my macbook, this is the native apple one).
Indeed, after downloading jdk 1.6 from Sun/Oracle and running tests with this version, the deserialization/serialization test case failed.</p>

<p>The failure is quite peculiar one: some elements that are not <em>nil</em> in XML source are marked <code>xsi:nil="true"</code> in the result. But not all of them. The result is correct
until the first <code>xsi:nil="true"</code> in the source. All following <em>nil</em>-able elements (ie wrapped by <code>JAXBElement</code>) are marked as <em>nil</em>. Apparently, the JAXB unmarshalling code fails to reset
some internal state flag (and debugging the code confirms this observation).</p>

<p>To check different implementations, I&#8217;ve made <a href="https://github.com/podlesh/jaxb-bug">testing tool</a>. Just to be sure, it checks all four variations of nil and non-nil elements. In reality, it is always the last list that displays either OK or ERROR.</p>

<p>Result on jdk 1.6:</p>

<pre><code>resource `incorrect1.xml` unmarshalled to class eu.lmc.bug.jaxb.ElementBug
  A is nil    , expected nil     (OK)
  B is nil    , expected element ERROR!
</code></pre>

<p>Result on jdk 1.7:</p>

<pre><code>resource `incorrect1.xml` unmarshalled to class eu.lmc.bug.jaxb.ElementBug
  A is nil    , expected nil     (OK)
  B is element, expected element (OK)
</code></pre>

<h1>Solution</h1>

<p>There is no real workaround, but there are two ways how to use correct implementation:</p>

<ul>
<li>upgrade to jdk 1.7</li>
<li>use correct <code>jaxb-impl-X.jar</code> (it overrides the embedded version)</li>
</ul>


<p>When using JAXB-RI, don&#8217;t forget to check it for this bug. According to <a href="http://jaxb.java.net/guide/Which_JAXB_RI_is_included_in_which_JDK_.html">jaxb.java.net</a>, it looks like this bug is limited to versions 2.1.x</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/technology/blog/2012/12/08/jpa-batch-update/">JPA Batch Update</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-08T12:34:00+01:00" pubdate data-updated="true">Dec 8<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve just spent few hours hunting some very weird bug in our new JPA code and found out that hibernate 4 (I don&#8217;t know about other JPA implementations) does not clear cache on HQL batch updates.</p>

<p>This code fill some initial values to previously <code>null</code> columns:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">fillOilife</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">&quot;UPDATE PdjdOrderItem poi SET poi.oilife = :oilife &quot;</span> <span class="o">+</span>
</span><span class='line'>                <span class="s">&quot;WHERE poi.pdjdGeneration&gt;0 AND poi.oistate = :oistate AND poi.oilife is NULL&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;oilife&quot;</span><span class="o">,</span> <span class="n">INITIAL_OILIFE</span><span class="o">);</span>
</span><span class='line'>        <span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;oistate&quot;</span><span class="o">,</span> <span class="n">VALID_OISTATE</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The update is correctly processed into SQL query and executed, but the session cache remains as it is. I&#8217;ve expected hibernate to detect that PdjdOrderItem is being changed and to clear all cached entities (or just the changed ones, but that would be unreasonably complicated). Hibernate, however, does nothing and happily server stale PdjdOrderItem entities with <code>null</code> values.</p>

<p>Solution is quite simple, if a little annoying: clear the cache by explicit <code>clear()</code> call:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">fillOilife</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">em</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</span><span class='line'>        <span class="n">em</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class='line'>        <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">&quot;UPDATE PdjdOrderItem poi SET poi.oilife = :oilife &quot;</span> <span class="o">+</span>
</span><span class='line'>                <span class="s">&quot;WHERE poi.pdjdGeneration&gt;0 AND poi.oistate = :oistate AND poi.oilife is NULL&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;oilife&quot;</span><span class="o">,</span> <span class="n">INITIAL_OILIFE</span><span class="o">);</span>
</span><span class='line'>        <span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;oistate&quot;</span><span class="o">,</span> <span class="n">VALID_OISTATE</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But I still feel disappointed.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/technology/blog/2012/11/14/funny-column-names/">JPA, HSQLDB and Funny Column Names</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-14T17:32:00+01:00" pubdate data-updated="true">Nov 14<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There is probably no need to introduce <a href="http://hsqldb.org">hsqldb</a>, let&#8217;s just say that it&#8217;s invaluable tool for automated (integration) tests of java/sql code. Especially when combined with Hibernate/JPA and its automatic ddl.</p>

<p>There are, however, pitfalls. One of them looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2012-11-08 18:08:46,257] [main] (ERROR) hibernate.tool.hbm2ddl.SchemaExport - HHH000389: Unsuccessful: create table PUBLIC.ADDRESS_CNDP (ADDRESS_ID bigint not null, $SEC_DOMAIN_G2ID bigint, DETAIL varchar(100), GIS_ID varchar(255), NUMBER varchar(16), ORIENTATION_NUMBER varchar(16), STATUS integer, STR_CITY varchar(100), STR_CITYPART varchar(100), STR_COUNTRY varchar(100), STR_DISTRICT varchar(100), STR_REGION varchar(100), STR_STREET varchar(100), STR_TERRITORY varchar(100), TYPE integer, ZIP varchar(255), CITY_ID integer, CITYPART_ID integer, COUNTRY_ID integer, DISTRICT_ID integer, REGION_ID integer, STREET_ID integer, TERRITORY_ID integer, primary key (ADDRESS_ID))
</span><span class='line'>[2012-11-08 18:08:46,257] [main] (ERROR) hibernate.tool.hbm2ddl.SchemaExport - unknown token: </span></code></pre></td></tr></table></div></figure>


<p>Yes, that&#8217;s all - the error message ends by colon. Not really helpful&#8230;</p>

<p>After some digging, the culprit has been found: the &#8220;dollar&#8221; sign <strong>$</strong> in column name. Of course, using such character is <del>stupid</del> <em>controversial</em>, but it&#8217;s too late now - the main db2 database is already eight years old and changing column name without real reason is overkill. Similar problem happens with other <em>controversial</em> column name choices, like <code>ORDER</code>, <code>COUNT</code> or <code>PACKAGE</code>.</p>

<p>Fortunately, both hibernate and JPA hsqldb can handle such names and the solution is actually quite simple: just quote them.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="c1">//ORDER is reserved word</span>
</span><span class='line'>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;\&quot;ORDER\&quot;&quot;</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">order</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//$ is special character!</span>
</span><span class='line'>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;\&quot;$SEC_DOMAIN_G2ID\&quot;&quot;</span><span class="o">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">$secDomain</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//no quoting is needed here</span>
</span><span class='line'>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PARAM&quot;</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">255</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">param</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hibernate internally converts quotes (they are actually part of JPA2.0 standard) to back-ticks (that&#8217;s hibernate-specific way to escape names) and then back to quotes (in <code>org.hibernate.dialect.HSQLDialect</code>).</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/technology/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/technology/blog/2013/02/19/swiffy-for-swf-banners-help/">Swiffy For SWF Banners Help</a>
      </li>
    
      <li class="post">
        <a href="/technology/blog/2013/01/21/groovy-testng-tests/">groovy testng tests</a>
      </li>
    
      <li class="post">
        <a href="/technology/blog/2013/01/20/jaxb-bug-in-java-6/">JAXB bug in java 6</a>
      </li>
    
      <li class="post">
        <a href="/technology/blog/2012/12/08/jpa-batch-update/">JPA batch update</a>
      </li>
    
      <li class="post">
        <a href="/technology/blog/2012/11/14/funny-column-names/">JPA, HSQLDB and Funny column names</a>
      </li>
    
  </ul>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - LMC s.r.o. -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
